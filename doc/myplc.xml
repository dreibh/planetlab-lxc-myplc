<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.3//EN"
"http://www.oasis-open.org/docbook/xml/4.3/docbookx.dtd" [
  <!ENTITY Variables SYSTEM "variables.xml">
]>
<article>
  <articleinfo>
    <title>MyPLC User's Guide</title>

    <author>
      <firstname>Mark Huang</firstname>
    </author>

    <affiliation>
      <orgname>Princeton University</orgname>
    </affiliation>

    <abstract>
      <para>This document describes the design, installation, and
      administration of MyPLC, a complete PlanetLab Central (PLC)
      portable installation contained within a
      <command>chroot</command> jail. This document assumes advanced
      knowledge of the PlanetLab architecture and Linux system
      administration.</para>
    </abstract>

    <revhistory>
      <revision>
        <revnumber>1.0</revnumber>

        <date>April 7, 2006</date>

        <authorinitials>MLH</authorinitials>

        <revdescription>
          <para>Initial draft.</para>
        </revdescription>
      </revision>
    </revhistory>
  </articleinfo>

  <section>
    <title>Overview</title>

    <para>MyPLC is a complete PlanetLab Central (PLC) portable
    installation contained within a <command>chroot</command>
    jail. The default installation consists of a web server, an
    XML-RPC API server, a boot server, and a database server: the core
    components of PLC. The installation is customized through an
    easy-to-use graphical interface. All PLC services are started up
    and shut down through a single script installed on the host
    system. The usually complex process of installing and
    administering the PlanetLab backend is reduced by containing PLC
    services within a virtual filesystem. By packaging it in such a
    manner, MyPLC may also be run on any modern Linux distribution,
    and could conceivably even run in a PlanetLab slice.</para>

    <figure id="Architecture">
      <title>MyPLC architecture</title>
      <mediaobject>
        <imageobject>
          <imagedata fileref="architecture.eps" format="EPS" align="center" scale="50" />
        </imageobject>
        <imageobject>
          <imagedata fileref="architecture.png" format="PNG" align="center" scale="50" />
        </imageobject>
        <textobject>
          <phrase>MyPLC architecture</phrase>
        </textobject>
        <caption>
          <para>MyPLC should be viewed as a single application that
          provides multiple functions and can run on any host
          system.</para>
	</caption>
      </mediaobject>
    </figure>
  </section>

  <section>
    <title>Installation</title>

    <para>Though internally composed of commodity software
    subpackages, MyPLC should be treated as a monolithic software
    application. MyPLC is distributed as single RPM package that has
    no external dependencies, allowing it to be installed on
    practically any Linux 2.6 based distribution:</para>

    <example>
      <title>Installing MyPLC.</title>

	<programlisting><![CDATA[# If your distribution supports RPM
rpm -U myplc-0.3-1.planetlab.i386.rpm

# If your distribution does not support RPM
cd /
rpm2cpio myplc-0.3-1.planetlab.i386.rpm | cpio -diu]]></programlisting>
    </example>

    <para>MyPLC installs the following files and directories:</para>

    <itemizedlist>

      <listitem><para><filename>/plc/root.img</filename>: The main
      root filesystem of the MyPLC application. This file is an
      uncompressed ext3 filesystem that is loopback mounted on
      <filename>/plc/root</filename> when MyPLC starts. The
      filesystem, even when mounted, should be treated an opaque
      binary that can and will be replaced in its entirety by any
      upgrade of MyPLC.</para></listitem>

      <listitem><para><filename>/plc/root</filename>: The mount point
      for <filename>/plc/root.img</filename>. Once the root filesystem
      is mounted, all MyPLC services run in a
      <command>chroot</command> jail based in this
      directory.</para></listitem>

      <listitem>
	<para><filename>/plc/data</filename>: The directory where user
	data and generated files are stored. This directory is bind
	mounted into the <command>chroot</command> jail on
	<filename>/data</filename>. Files in this directory are marked
	with <command>%config(noreplace)</command> in the RPM. That
	is, during an upgrade of MyPLC, if a file has not changed
	since the last installation or upgrade of MyPLC, it is subject
	to upgrade and replacement. If the file has chanegd, the new
	version of the file will be created with a
	<filename>.rpmnew</filename> extension. Symlinks within the
	MyPLC root filesystem ensure that the following directories
	(relative to <filename>/plc/root</filename>) are stored
	outside the MyPLC filesystem image:</para>

	<itemizedlist>
	  <listitem><para><filename>/etc/planetlab</filename>: This
	  directory contains the configuration files, keys, and
	  certificates that define your MyPLC
	  installation.</para></listitem>

	  <listitem><para><filename>/var/lib/pgsql</filename>: This
	  directory contains PostgreSQL database
	  files.</para></listitem>

	  <listitem><para><filename>/var/www/html/alpina-logs</filename>: This
	  directory contains node installation logs.</para></listitem>

	  <listitem><para><filename>/var/www/html/boot</filename>: This
	  directory contains the Boot Manager, customized for your MyPLC
	  installation, and its data files.</para></listitem>

	  <listitem><para><filename>/var/www/html/download</filename>: This
	  directory contains Boot CD images, customized for your MyPLC
	  installation.</para></listitem>

	  <listitem><para><filename>/var/www/html/install-rpms</filename>: This
	  directory is where you should install node package updates,
	  if any. By default, nodes are installed from the tarball
	  located at
	  <filename>/var/www/html/boot/PlanetLab-Bootstrap.tar.bz2</filename>,
	  which is pre-built from the latest PlanetLab Central
	  sources, and installed as part of your MyPLC
	  installation. However, nodes will attempt to install any
	  newer RPMs located in
	  <filename>/var/www/html/install-rpms/planetlab</filename>,
	  after initial installation and periodically thereafter. You
	  must run <command>yum-arch</command> and
	  <command>createrepo</command> to update the
	  <command>yum</command> caches in this directory after
	  installing a new RPM. PlanetLab Central cannot support any
	  changes to this file.</para></listitem>

	  <listitem><para><filename>/var/www/html/xml</filename>: This
	  directory contains various XML files that the Slice Creation
	  Service uses to determine the state of slices. These XML
	  files are refreshed periodically by <command>cron</command>
	  jobs running in the MyPLC root.</para></listitem>
	</itemizedlist>
      </listitem>

      <listitem>
	<para><filename>/etc/init.d/plc</filename>: This file
	is a System V init script installed on your host filesystem,
	that allows you to start up and shut down MyPLC with a single
	command. On a Red Hat or Fedora host system, it is customary to
	use the <command>service</command> command to invoke System V
	init scripts:</para>

	<example id="StartingAndStoppingMyPLC">
	  <title>Starting and stopping MyPLC.</title>

	  <programlisting><![CDATA[# Starting MyPLC
service plc start

# Stopping MyPLC
service plc stop]]></programlisting>
	</example>

	<para>Like all other registered System V init services, MyPLC is
	started and shut down automatically when your host system boots
	and powers off. You may disable automatic startup by invoking
	the <command>chkconfig</command> command on a Red Hat or Fedora
	host system:</para>

	<example>
	  <title>Disabling automatic startup of MyPLC.</title>

	  <programlisting><![CDATA[# Disable automatic startup
chkconfig plc off

# Enable automatic startup
chkconfig plc on]]></programlisting>
	</example>
      </listitem>

      <listitem><para><filename>/etc/sysconfig/plc</filename>: This
      file is a shell script fragment that defines the variables
      <envar>PLC_ROOT</envar> and <envar>PLC_DATA</envar>. By default,
      the values of these variables are <filename>/plc/root</filename>
      and <filename>/plc/data</filename>, respectively. If you wish,
      you may move your MyPLC installation to another location on your
      host filesystem and edit the values of these variables
      appropriately, but you will break the RPM upgrade
      process. PlanetLab Central cannot support any changes to this
      file.</para></listitem>

      <listitem><para><filename>/etc/planetlab</filename>: This
      symlink to <filename>/plc/data/etc/planetlab</filename> is
      installed on the host system for convenience.</para></listitem>
    </itemizedlist>
  </section>

  <section>
    <title>Quickstart</title>

    <para>Once installed, start MyPLC (see <xref
    linkend="StartingAndStoppingMyPLC" />). MyPLC must be started as
    root. Observe the output of this command for any failures. If no
    failures occur, you should see output similar to the
    following:</para>

    <example>
      <title>A successful MyPLC startup.</title>

      <programlisting><![CDATA[Mounting PLC:                                              [  OK  ]
PLC: Generating network files:                             [  OK  ]
PLC: Starting system logger:                               [  OK  ]
PLC: Starting database server:                             [  OK  ]
PLC: Generating SSL certificates:                          [  OK  ]
PLC: Generating SSH keys:                                  [  OK  ]
PLC: Starting web server:                                  [  OK  ]
PLC: Bootstrapping the database:                           [  OK  ]
PLC: Starting crond:                                       [  OK  ]
PLC: Rebuilding Boot CD:                                   [  OK  ]
PLC: Rebuilding Boot Manager:                              [  OK  ]
]]></programlisting>
    </example>

    <para>If <filename>/plc/root</filename> is mounted successfully, a
    complete log file of the startup process may be found at
    <filename>/plc/root/var/log/boot.log</filename>. Possible reasons
    for failure of each step include:</para>

    <itemizedlist>
      <listitem><para><literal>Mounting PLC</literal>: If this step
      fails, first ensure that you started MyPLC as root. Check
      <filename>/etc/sysconfig/plc</filename> to ensure that
      <envar>PLC_ROOT</envar> and <envar>PLC_DATA</envar> refer to the
      right locations. You may also have too many existing loopback
      mounts, or your kernel may not support loopback mounting, bind
      mounting, or the ext3 filesystem. Try freeing at least one
      loopback device, or re-compiling your kernel to support loopback
      mounting, bind mounting, and the ext3
      filesystem.</para></listitem>

      <listitem><para><literal>Starting database server</literal>: If
      this step fails, check
      <filename>/plc/root/var/log/pgsql</filename> and
      <filename>/plc/root/var/log/boot.log</filename>. The most common
      reason for failure is that the default PostgreSQL port, TCP port
      5432, is already in use. Check that you are not running a
      PostgreSQL server on the host system.</para></listitem>

      <listitem><para><literal>Starting web server</literal>: If this
      step fails, check
      <filename>/plc/root/var/log/httpd/error_log</filename> and
      <filename>/plc/root/var/log/boot.log</filename> for obvious
      errors. The most common reason for failure is that the default
      web ports, TCP ports 80 and 443, are already in use. Check that
      you are not running a web server on the host
      system.</para></listitem>

      <listitem><para><literal>Bootstrapping the database</literal>:
      If this step fails, it is likely that the previous step
      (<literal>Starting web server</literal>) also failed. Another
      reason that it could fail is if <envar>PLC_API_HOST</envar> (see
      <xref linkend="ChangingTheConfiguration" />) does not resolve to
      the host on which the API server has been enabled. By default,
      all services, including the API server, are enabled and run on
      the same host, so check that <envar>PLC_API_HOST</envar> is
      either <filename>localhost</filename> or resolves to a local IP
      address.</para></listitem>

      <listitem><para><literal>Starting crond</literal>: If this step
      fails, it is likely that the previous steps (<literal>Starting
      web server</literal> and <literal>Bootstrapping the
      database</literal>) also failed. If not, check
      <filename>/plc/root/var/log/boot.log</filename> for obvious
      errors. This step starts the <command>cron</command> service and
      generates the initial set of XML files that the Slice Creation
      Service uses to determine slice state.</para></listitem>
    </itemizedlist>

    <para>If no failures occur, then MyPLC should be active with a
    default configuration. Open a web browser on the host system and
    visit <literal>http://localhost/</literal>, which should bring you
    to the front page of your PLC installation. The password of the
    default administrator account
    <literal>root@localhost.localdomain</literal> (set by
    <envar>PLC_ROOT_USER</envar>) is <literal>root</literal> (set by
    <envar>PLC_ROOT_PASSWORD</envar>).</para>

    <section id="ChangingTheConfiguration">
      <title>Changing the configuration</title>

      <para>After verifying that MyPLC is working correctly, shut it
      down and begin changing some of the default variable
      values. Shut down MyPLC with <command>service plc stop</command>
      (see <xref linkend="StartingAndStoppingMyPLC" />). With a text
      editor, open the file
      <filename>/etc/planetlab/plc_config.xml</filename>. This file is
      a self-documenting configuration file written in XML. Variables
      are divided into categories. Variable identifiers must be
      alphanumeric, plus underscore. A variable is referred to
      canonically as the uppercase concatenation of its category
      identifier, an underscore, and its variable identifier. Thus, a
      variable with an <literal>id</literal> of
      <literal>slice_prefix</literal> in the <literal>plc</literal>
      category is referred to canonically as
      <envar>PLC_SLICE_PREFIX</envar>.</para>

      <para>The reason for this convention is that during MyPLC
      startup, <filename>plc_config.xml</filename> is translated into
      several different languages&mdash;shell, PHP, and
      Python&mdash;so that scripts written in each of these languages
      can refer to the same underlying configuration. Most MyPLC
      scripts are written in shell, so the convention for shell
      variables predominates.</para>

      <para>The variables that you should change immediately are:</para>

      <itemizedlist>
	<listitem><para><envar>PLC_NAME</envar>: Change this to the
	name of your PLC installation.</para></listitem>
	<listitem><para><envar>PLC_ROOT_PASSWORD</envar>: Change this
	to a more secure password.</para></listitem>

	<listitem><para><envar>PLC_NET_DNS1</envar>,
	<envar>PLC_NET_DNS2</envar>: Change these to the IP addresses
	of your primary and secondary DNS servers. Check
	<filename>/etc/resolv.conf</filename> on your host
	filesystem.</para></listitem>

	<listitem><para><envar>PLC_MAIL_SUPPORT_ADDRESS</envar>:
	Change this to the e-mail address at which you would like to
	receive support requests.</para></listitem>

	<listitem><para><envar>PLC_DB_HOST</envar>,
	<envar>PLC_API_HOST</envar>, <envar>PLC_WWW_HOST</envar>,
	<envar>PLC_BOOT_HOST</envar>: Change all of these to the
	preferred FQDN of your host system.</para></listitem>
      </itemizedlist>

      <para>After changing these variables, save the file, then
      restart MyPLC with <command>service plc start</command>. You
      should notice that the password of the default administrator
      account is no longer <literal>root</literal>, and that the
      default site name includes the name of your PLC installation
      instead of PlanetLab.</para>
    </section>

    <section>
      <title>Installing nodes</title>

      <para>Install your first node by clicking <literal>Add
      Node</literal> under the <literal>Nodes</literal> tab. Fill in
      all the appropriate details, then click
      <literal>Add</literal>. Download the node's configuration file
      by clicking <literal>Download configuration file</literal> on
      the <emphasis role="bold">Node Details</emphasis> page for the
      node. Save it to a floppy disk or USB key as detailed in <xref
      linkend="TechsGuide" />.</para>

      <para>Follow the rest of the instructions in <xref
      linkend="TechsGuide" /> for creating a Boot CD and installing
      the node, except download the Boot CD image from the
      <filename>/download</filename> directory of your PLC
      installation, not from PlanetLab Central. The images located
      here are customized for your installation. If you change the
      hostname of your boot server (<envar>PLC_BOOT_HOST</envar>), or
      if the SSL certificate of your boot server expires, MyPLC will
      regenerate it and rebuild the Boot CD with the new
      certificate. If this occurs, you must replace all Boot CDs
      created before the certificate was regenerated.</para>

      <para>The installation process for a node has significantly
      improved since PlanetLab 3.3. It should now take only a few
      seconds for a new node to become ready to create slices.</para>
    </section>

    <section>
      <title>Administering nodes</title>

      <para>You may administer nodes as <literal>root</literal> by
      using the SSH key stored in
      <filename>/etc/planetlab/root_ssh_key.rsa</filename>.</para>

      <example>
	<title>Accessing nodes via SSH. Replace
	<literal>node</literal> with the hostname of the node.</title>

	<programlisting>ssh -i /etc/planetlab/root_ssh_key.rsa root@node</programlisting>
      </example>

      <para>Besides the standard Linux log files located in
      <filename>/var/log</filename>, several other files can give you
      clues about any problems with active processes:</para>

      <itemizedlist>
	<listitem><para><filename>/var/log/pl_nm</filename>: The log
	file for the Node Manager.</para></listitem>

	<listitem><para><filename>/vservers/pl_conf/var/log/pl_conf</filename>:
	The log file for the Slice Creation Service.</para></listitem>

	<listitem><para><filename>/var/log/propd</filename>: The log
	file for Proper, the service which allows certain slices to
	perform certain privileged operations in the root
	context.</para></listitem>

	<listitem><para><filename>/vservers/pl_netflow/var/log/netflow.log</filename>:
	The log file for PlanetFlow, the network traffic auditing
	service.</para></listitem>
      </itemizedlist>
    </section>

    <section>
      <title>Creating a slice</title>

      <para>Create a slice by clicking <literal>Create Slice</literal>
      under the <literal>Slices</literal> tab. Fill in all the
      appropriate details, then click <literal>Create</literal>. Add
      nodes to the slice by clicking <literal>Manage Nodes</literal>
      on the <emphasis role="bold">Slice Details</emphasis> page for
      the slice.</para>

      <para>A <command>cron</command> job runs every five minutes and
      updates the file
      <filename>/plc/data/var/www/html/xml/slices-0.5.xml</filename>
      with information about current slice state. The Slice Creation
      Service running on every node polls this file every ten minutes
      to determine if it needs to create or delete any slices. You may
      accelerate this process manually if desired.</para>

      <example>
	<title>Forcing slice creation on a node.</title>

	<programlisting><![CDATA[# Update slices.xml immediately
service plc start crond

# Kick the Slice Creation Service on a particular node.
ssh -i /etc/planetlab/root_ssh_key.rsa root@node \
vserver pl_conf exec service pl_conf restart]]></programlisting>
      </example>
    </section>
  </section>

  <appendix>
    <title>Configuration variables</title>

    <para>Listed below is the set of standard configuration variables
    and their default values, defined in the template
    <filename>/etc/planetlab/default_config.xml</filename>. Additional
    variables and their defaults may be defined in site-specific XML
    templates that should be placed in
    <filename>/etc/planetlab/configs/</filename>.</para>

    &Variables;
  </appendix>

  <bibliography>
    <title>Bibliography</title>

    <biblioentry id="TechsGuide">
      <author><firstname>Mark</firstname><surname>Huang</surname></author>
      <title><ulink
      url="http://www.planet-lab.org/doc/TechsGuide.php">PlanetLab
      Technical Contact's Guide</ulink></title>
    </biblioentry>
  </bibliography>
</article>
